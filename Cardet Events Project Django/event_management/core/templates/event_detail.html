{% extends 'base.html' %}
{% load static %}
{% block title %}Event Details{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">Event Details</h1>
        <a href="{% url 'event_edit' event.id %}?next={{ request.get_full_path }}" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">
            ‚úèÔ∏è Edit Event
        </a>
    </div>

<div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <!-- Event Information Block -->
    <div class="flex flex-col md:flex-row items-center mb-6">
        <div class="w-full md:w-1/3">
            {% if event.image %}
                <img src="{{ event.image.url }}" alt="{{ event.event_name }}" class="rounded-lg shadow-md w-full">
            {% else %}
                <div class="w-full h-48 bg-gray-300 flex items-center justify-center rounded-lg shadow-md">
                    <span class="text-gray-600">No Image</span>
                </div>
            {% endif %}
        </div>
        <div class="w-full md:w-2/3 md:pl-6">
            <h1 class="text-2xl font-semibold">{{ event.event_name }}</h1>
            <p class="text-gray-600 mt-2"><strong>Date:</strong> {{ event.event_date }}</p>
            <p class="text-gray-600"><strong>Time:</strong> {{ event.start_time }} - {{ event.end_time }}</p>
            <p class="text-gray-600"><strong>Location:</strong> {{ event.location }}</p>
            <p class="text-gray-600 mt-3"><strong>Description:</strong> {{ event.description|safe }}</p>
            <p class="mt-4 inline-block px-3 py-1 rounded-lg" style="background-color: {{ event.status.color }}; color: white;">
                Status: {{ event.status.name }}
            </p>
            {% if event.public_registration_enabled %}
                <div class="mt-4 bg-green-100 text-green-800 p-3 rounded-lg border border-green-400 pr-4">
                    {% if event.status.name|lower == 'on-going' %}
                    <p><strong>Public Registration Link:</strong></p>
                    <a href="{{ request.scheme }}://{{ request.get_host }}{% url 'public_register' event.uuid %}" 
                       target="_blank" 
                       class="text-blue-600 underline break-all">
                        {{ request.scheme }}://{{ request.get_host }}{% url 'public_register' event.uuid %}
                    </a>
                {% else %}
                    <p><strong>‚ÑπÔ∏è Public Registration is enabled, but the event is not active.</strong></p>
                    <p class="text-sm">Change the status to <strong>on-going</strong> to display the public registration link.</p>
                {% endif %}
                </div>
            {% endif %}
            <!-- Registration, Present, and Not Present in One Line -->
            <div class="flex flex-wrap items-center gap-6 mt-2">
                <p class="flex items-center gap-1 text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5V10l-2.5-2L17 10v10zm-4 0H2V10l2.5-2L7 10v10zm-4 0h2V10l-2.5-2L5 10v10z" />
                    </svg>
                    <span><strong>Registrations:</strong> {{ participants|length }}</span>
                </p>
            
                <p class="flex items-center gap-1 text-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span><strong>Present:</strong> {{ present_participants|length }}</span>
                </p>
            
                <p class="flex items-center gap-1 text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span><strong>Not Present:</strong> {{ not_present_participants|length }}</span>
                </p>
            </div>
            
        </div>
            
               
            

    </div>
    


<!-- Action Buttons Section -->
<div class="mt-8 space-y-4 p-4 bg-gray-100 rounded-lg">

    <!-- Action Buttons Row -->
    <div class="flex flex-wrap gap-4 justify-start items-center">

        <!-- Scan Tickets Button -->
        {% if event.tickets and not event.signatures %}
            <a href="{% url 'scan_qr' event.id %}"
            class="bg-purple-500 text-white px-6 py-3 rounded-lg flex items-center gap-2 hover:bg-purple-700 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13 16h-1v-4h-1m1 0h1m4-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Scan Tickets
            </a>
        {% elif event.tickets and event.signatures %}
            <a href="{% url 'scan_qr' event.id %}"
            class="bg-purple-500 text-white px-6 py-3 rounded-lg flex items-center gap-2 hover:bg-purple-700 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13 16h-1v-4h-1m1 0h1m4-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Scan Tickets & Collect Signatures
            </a>
        {% elif event.signatures and not event.tickets %}
            <p class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Use the registrants table below to collect signatures</p>
        {% else %}
            <p class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">No tickets or signatures available</p>
        {% endif %}

        <!-- Export ZIP Button -->
        <a href="{% url 'export_zip' event.id %}"
        class="bg-blue-500 text-white px-6 py-3 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v16H4z M9 9h6v6H9z" />
            </svg>
            Export ZIP
        </a>

        <!-- Export CSV Button -->
        <a href="{% url 'export_participants_csv' event.id %}"
        class="bg-green-500 text-white px-6 py-3 rounded-lg flex items-center gap-2 hover:bg-green-700 transition duration-200">
            üìÑ Export CSV
        </a>

        <!-- Export PDF Button -->
        <a href="{% url 'export_participants_pdf' event.id %}"
        class="bg-red-500 text-white px-6 py-3 rounded-lg flex items-center gap-2 hover:bg-red-700 transition duration-200">
            üìë Export PDF
        </a>
    </div>
</div>


    <!-- Add Participant Button -->
    <div class="text-right mb-4">
        <button id="addParticipantBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Participant
        </button>
    </div>

    <!-- Participant Form (Hidden by Default) -->
    <div id="participantForm" class="hidden bg-gray-100 p-4 rounded-lg shadow-md">

        <form method="POST">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="id_name" class="block text-gray-700 font-semibold">Name</label>
                    <input type="text" name="name" id="id_name" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="id_email" class="block text-gray-700 font-semibold">Email</label>
                    <input type="email" name="email" id="id_email" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="md:col-span-2">
                    <label for="id_phone" class="block text-gray-700 font-semibold">Phone</label>
                    <input type="text" name="phone" id="id_phone" class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
            <div class="text-right mt-4">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Submit
                </button>
            </div>
        </form>
    </div>
	{% if messages %}
    <div id="messageContainer" class="max-w-4xl mx-auto mt-4">
        {% for message in messages %}
            <div class="p-4 mb-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700 border-green-400{% elif message.tags == 'error' %}bg-red-100 text-red-700 border-red-400{% endif %}">
                <span class="font-semibold">{{ message }}</span>
            </div>
        {% endfor %}
    </div>
{% endif %}


    <!-- Participants Table with DataTables & Export Options -->
    <h2 class="text-xl font-semibold mb-4">Registered Participants</h2>
    <div class="overflow-x-auto">
        <table id="participantsTable" class="w-full border-collapse border border-gray-300 stripe hover row-border">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-gray-300 px-4 py-2">#</th>
                    <th class="border border-gray-300 px-4 py-2">Name</th>
                    <th class="border border-gray-300 px-4 py-2">Email</th>
                    <th class="border border-gray-300 px-4 py-2">Phone</th>
                    {% if event.tickets %}
                        <th class="border border-gray-300 px-4 py-2">PDF Ticket</th>
                        <th class="border border-gray-300 px-4 py-2">Send Ticket</th> <!-- ‚úÖ New Button -->
                    {% endif %}
                    {% if event.signatures %}
                        <th class="border border-gray-300 px-4 py-2">Signature</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody id="participant-table">
                {% for participant in participants %}
                <tr class="text-center">
                    <td class="border border-gray-300 px-4 py-2">{{ forloop.counter }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ participant.name }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ participant.email }}</td>
                    <td class="border border-gray-300 px-4 py-2">{{ participant.phone|default:"-" }}</td>
            
                    {% if event.tickets %}
                        <td class="border border-gray-300 px-4 py-2">
                            {% if participant.pdf_ticket %}
                                <a href="{{ participant.pdf_ticket.url }}" target="_blank" class="text-blue-500 underline">Download</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
            
                        <!-- ‚úÖ "Send Ticket" Button (Disabled if signed) -->
                        <td class="border border-gray-300 px-4 py-2">
                            {% if participant.pdf_ticket %}
                                <button class="send-ticket-btn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-700 {% if participant.attendance and participant.attendance.signature_file %}opacity-50 cursor-not-allowed{% endif %}"
                                        data-participant-id="{{ participant.id }}" 
                                        {% if participant.attendance and participant.attendance.signature_file %}disabled{% endif %}>
                                    Send Ticket
                                </button>
                            {% else %}
                                <span class="text-gray-500">No Ticket</span>
                            {% endif %}
                        </td>
                    {% endif %}
            
                    {% if event.signatures %}
                        <td class="border border-gray-300 px-4 py-2">
                            {% if participant.attendance and participant.attendance.signature_file %}
                                <!-- ‚úÖ Show Signature Image -->
                                <a href="{{ participant.attendance.signature_file.url }}" target="_blank">
                                    <img src="{{ participant.attendance.signature_file.url }}" alt="Signature" class="h-10 w-auto border rounded">
                                </a>
                            {% else %}
                                {% if not event.tickets %}
                                    <a href="{% url 'sign_signature' event.id participant.id %}"
                                       class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                        Sign
                                    </a>
                                {% else %}
                                    <span class="text-red-600 font-semibold">‚ùå Not Signed</span>
                                {% endif %}
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center border border-gray-300 px-4 py-2">No participants registered</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
 




<!-- JavaScript to Show/Hide Participant Form -->

<script src="{% static 'js/show_hide_add_participant.js' %}"></script>
<script src="{% static 'js/autohide_messages.js' %}"></script>


<!-- DataTables Scripts with Export Buttons and Page Length Selector -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


<script>
    $(document).ready(function () {
        let eventDetails = `
            <h2>{{ event.event_name }}</h2>
            <p><strong>Date:</strong> {{ event.event_date }}</p>
            <p><strong>Time:</strong> {{ event.start_time }} - {{ event.end_time }}</p>
            <p><strong>Location:</strong> {{ event.location }}</p>
            <p><strong>Description:</strong> {{ event.description|safe }}</p>
            <p><strong>Status:</strong> {{ event.status.name }}</p>
        `;

        $('#participantsTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "responsive": true,
            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            "pageLength": 10,
            "dom": '<"top"lfB>rt<"bottom"ip><"clear">',
            "buttons": [
                { extend: 'csv', text: 'Export CSV' },
                {
                    extend: 'pdfHtml5',
                    text: 'Export PDF',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    customize: function (doc) {
                        // ‚úÖ Add Event Details at the top
                        doc.content.unshift(
                            {
                                text: `Event: {{ event.event_name }}`,
                                fontSize: 14,
                                bold: true,
                                margin: [0, 0, 0, 10] // Margin bottom
                            },
                            {
                                text: `Date: {{ event.event_date }}   |   Location: {{ event.location }}`,
                                fontSize: 12,
                                margin: [0, 0, 0, 10] // Margin bottom
                            }
                        );

                        // ‚úÖ Convert Signature Images to Base64 and Add to PDF
                        let signatureImages = document.querySelectorAll('.signature-img');
                        signatureImages.forEach((img, index) => {
                            let canvas = document.createElement('canvas');
                            let ctx = canvas.getContext('2d');
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            ctx.drawImage(img, 0, 0);
                            let base64String = canvas.toDataURL('image/png');

                            // ‚úÖ Add Signature Image Below Participant Row
                            doc.content[2].table.body[index + 1].push({
                                image: base64String,
                                width: 50, // Adjust image size
                                alignment: 'center'
                            });
                        });
                    }
                }
            ]
        });

        // ‚úÖ Send Ticket Email Button
        $(".send-ticket-btn").click(function () {
            let participantId = $(this).data("participant-id");

            Swal.fire({
                title: "Send Ticket?",
                text: "Are you sure you want to send the ticket to this participant?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, Send"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "{% url 'send_ticket_email' %}",
                        method: "POST",
                        data: {
                            participant_id: participantId,
                            csrfmiddlewaretoken: "{{ csrf_token }}"
                        },
                        success: function (response) {
                            Swal.fire("Success", response.message, "success");
                        },
                        error: function (xhr) {
                            Swal.fire("Error", "Failed to send ticket. Try again later.", "error");
                        }
                    });
                }
            });
        });
    });
</script>


    

{% endblock %}