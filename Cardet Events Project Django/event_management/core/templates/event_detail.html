{% extends 'base.html' %}
{% load static %}
{% block title %}Event Details{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <!-- Event Information Block -->
    <div class="flex flex-col md:flex-row items-center mb-6">
        <div class="w-full md:w-1/3">
            {% if event.image %}
                <img src="{{ event.image.url }}" alt="{{ event.event_name }}" class="rounded-lg shadow-md w-full">
            {% else %}
                <div class="w-full h-48 bg-gray-300 flex items-center justify-center rounded-lg shadow-md">
                    <span class="text-gray-600">No Image</span>
                </div>
            {% endif %}
        </div>
        <div class="w-full md:w-2/3 md:pl-6">
            <h1 class="text-2xl font-semibold">{{ event.event_name }}</h1>
            <p class="text-gray-600 mt-2"><strong>Date:</strong> {{ event.event_date }}</p>
            <p class="text-gray-600"><strong>Time:</strong> {{ event.start_time }} - {{ event.end_time }}</p>
            <p class="text-gray-600"><strong>Location:</strong> {{ event.location }}</p>
            <p class="text-gray-600 mt-3"><strong>Description:</strong> {{ event.description|safe }}</p>
            <p class="mt-4 inline-block px-3 py-1 rounded-lg" style="background-color: {{ event.status.color }}; color: white;">
                Status: {{ event.status.name }}
            </p>
            <!-- Registration, Present, and Not Present in One Line -->
            <div class="flex flex-wrap gap-6 items-center mt-4">
                <p class="text-gray-600 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5V10l-2.5-2L17 10v10zm-4 0H2V10l2.5-2L7 10v10zm-4 0h2V10l-2.5-2L5 10v10z" />
                    </svg>
                    <span><strong>Registrations:</strong> {{ participants|length }}</span>
                </p>

                <p class="text-green-600 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span><strong>Present:</strong> {{ present_participants|length }}</span>
                </p>

                <p class="text-red-600 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span><strong>Not Present:</strong> {{ not_present_participants|length }}</span>
                </p>
            </div>

            {% if event.tickets or event.signatures %}
                <div class="mt-4 inline-block">
                    <a href="{% url 'scan_qr' event.id %}"
                    class="bg-purple-500 text-white px-6 py-2 rounded-lg flex items-center gap-2 hover:bg-purple-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1 0h1m4-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Check-In & Signatures
                    </a>
                </div>
            {%else%}
            <div class="mt-4 inline-block  "><p class>No QR Code Functionality</p></div>
            {% endif %}

        </div>

    </div>





    <!-- Add Participant Button -->
    <div class="text-right mb-4">
        <button id="addParticipantBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Participant
        </button>
    </div>

    <!-- Participant Form (Hidden by Default) -->
    <div id="participantForm" class="hidden bg-gray-100 p-4 rounded-lg shadow-md">

        <form method="POST">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="id_name" class="block text-gray-700 font-semibold">Name</label>
                    <input type="text" name="name" id="id_name" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="id_email" class="block text-gray-700 font-semibold">Email</label>
                    <input type="email" name="email" id="id_email" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="md:col-span-2">
                    <label for="id_phone" class="block text-gray-700 font-semibold">Phone</label>
                    <input type="text" name="phone" id="id_phone" class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
            <div class="text-right mt-4">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Submit
                </button>
            </div>
        </form>
    </div>
	{% if messages %}
    <div id="messageContainer" class="max-w-4xl mx-auto mt-4">
        {% for message in messages %}
            <div class="p-4 mb-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700 border-green-400{% elif message.tags == 'error' %}bg-red-100 text-red-700 border-red-400{% endif %}">
                <span class="font-semibold">{{ message }}</span>
            </div>
        {% endfor %}
    </div>
{% endif %}


    <!-- Participants Table with DataTables & Export Options -->
    <h2 class="text-xl font-semibold mb-4">Registered Participants</h2>
    <div class="overflow-x-auto">
        <table id="participantsTable" class="w-full border-collapse border border-gray-300 stripe hover row-border">
            <thead>
                <tr class="bg-gray-200">
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>PDF Ticket</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                <tr class="text-center">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ participant.name }}</td>
                    <td>{{ participant.email }}</td>
                    <td>{{ participant.phone|default:"-" }}</td>
                    <td>
                        {% if participant.pdf_ticket %}
                            <a href="{{ participant.pdf_ticket.url }}" target="_blank" class="text-blue-500 underline">Download</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center border border-gray-300 px-4 py-2">No participants registered</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
 




<!-- JavaScript to Show/Hide Participant Form -->

<script src="{% static 'js/show_hide_add_participant.js' %}"></script>
<script src="{% static 'js/autohide_messages.js' %}"></script>


<!-- DataTables Scripts with Export Buttons and Page Length Selector -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


<script>
$(document).ready( function () {
    $('#participantsTable').DataTable({
        "paging": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "responsive": true,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "pageLength": 10,  // Default number of rows to show
        "dom": '<"top"lfB>rt<"bottom"ip><"clear">', // Ensure the length change dropdown appears
        "buttons": [
            { extend: 'csv', text: 'Export CSV' },
            { extend: 'pdf', text: 'Export PDF' }
        ]
    });
});
</script>

{% endblock %}